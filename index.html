<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>保利物业抽奖活动</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: #1a5fb4;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .logo {
            width: 150px;
            height: 50px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 20px;
        }
        
        .section {
            padding: 20px;
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #1a5fb4;
            outline: none;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: #1a5fb4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #154b8a;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-admin {
            background: #e74c3c;
            margin-top: 10px;
        }
        
        .btn-admin:hover {
            background: #c0392b;
        }
        
        .btn-export {
            background: #27ae60;
            margin-top: 10px;
        }
        
        .btn-export:hover {
            background: #219a52;
        }
        
        .btn-import {
            background: #f39c12;
            margin-top: 10px;
        }
        
        .btn-import:hover {
            background: #d68910;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-edit {
            background: #3498db;
            padding: 8px 15px;
            margin: 2px;
        }

        .btn-delete {
            background: #e74c3c;
            padding: 8px 15px;
            margin: 2px;
        }

        .btn-reset {
            background: #9b59b6;
            padding: 8px 15px;
            margin: 2px;
        }

        .btn-logout {
            background: #95a5a6;
            margin-top: 10px;
        }

        .btn-logout:hover {
            background: #7f8c8d;
        }

        /* 四宫格抽奖样式 */
        .lottery-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px auto;
            max-width: 300px;
        }
        
        .grid-item {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #1a5fb4, #154b8a);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px;
            border: 3px solid transparent;
            box-shadow: 0 4px 15px rgba(26, 95, 180, 0.3);
        }
        
        .grid-item.active {
            background: linear-gradient(135deg, #ffd700, #ff6b6b);
            transform: scale(0.95);
            border-color: #ffd700;
            box-shadow: 0 0 20px gold;
            animation: pulse 0.5s ease-in-out;
        }
        
        .grid-item.thank {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(0.95); }
        }
        
        .lottery-container {
            position: relative;
            text-align: center;
        }
        
        .lottery-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        /* 中奖记录样式 */
        .record-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .record-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #1a5fb4;
        }
        
        .record-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        
        .record-prize {
            font-weight: bold;
            color: #1a5fb4;
            margin-top: 5px;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .nav {
            display: flex;
            justify-content: space-around;
            background: #f1f2f6;
            padding: 10px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 10px 15px;
            background: none;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            font-size: 14px;
            margin: 2px;
        }
        
        .nav-btn.active {
            background: #1a5fb4;
            color: white;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .success {
            background: #55efc4;
            color: #2d3436;
        }
        
        .error {
            background: #ff7675;
            color: white;
        }
        
        .lottery-btn-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .spin-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #1a5fb4, #154b8a);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(26, 95, 180, 0.4);
        }
        
        .spin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 95, 180, 0.6);
        }
        
        .spin-btn:disabled {
            background: #ccc;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        .format-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }
        
        .admin-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .admin-section {
            display: none;
        }
        
        .admin-section.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a5fb4;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: block;
            padding: 12px;
            background: #f39c12;
            color: white;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .whitelist-table, .prizes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .whitelist-table th, .whitelist-table td,
        .prizes-table th, .prizes-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .whitelist-table th, .prizes-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .upload-area {
            border: 2px dashed #1a5fb4;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            background: #f8f9fa;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #1a5fb4;
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        .github-config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div style="color: white; font-size: 24px; font-weight: bold;">保利®物业</div>
            </div>
            <h2>幸运大转盘</h2>
        </div>
        
        <!-- 登录页面 -->
        <div id="loginSection" class="section active">
            <div class="form-group">
                <input type="text" id="roomNumber" placeholder="请输入房号，例如：k10-1-1-101">
            </div>
            <div class="format-hint">房号格式：k10-1-1-101（楼栋-单元-楼层-房号）</div>
            
            <button class="btn" onclick="verifyUser()">业主登录</button>
            <button class="btn btn-admin" onclick="showAdminLogin()">管理员登录</button>
            
            <div class="message" style="background: #ffeaa7; color: #2d3436;">
                <p>温馨提示：</p>
                <p>1. 请输入正确的房号进行验证</p>
                <p>2. 每个房号仅有一次抽奖机会</p>
                <p>3. 中奖结果以系统记录为准</p>
            </div>
        </div>
        
        <!-- 管理员登录页面 -->
        <div id="adminLoginSection" class="section">
            <div class="form-group">
                <label for="adminAccount">管理员账号</label>
                <input type="text" id="adminAccount" placeholder="请输入管理员账号">
            </div>
            <div class="form-group">
                <label for="adminPassword">管理员密码</label>
                <input type="password" id="adminPassword" placeholder="请输入管理员密码">
            </div>
            <button class="btn" onclick="verifyAdmin()">管理员登录</button>
            <button class="btn" onclick="backToMainLogin()" style="background: #95a5a6; margin-top: 10px;">返回</button>
        </div>
        
        <!-- 业主主页面 -->
        <div id="mainSection" class="section">
            <div class="user-info">
                <h3 id="userWelcome">欢迎您！</h3>
                <p id="userDetails">房号：- | 姓名：- | 手机：-</p>
                <button class="btn btn-logout" onclick="userLogout()">退出登录</button>
            </div>
            
            <!-- 业主只有抽奖页面，没有记录页面 -->
            <div class="lottery-container">
                <div class="lottery-title">幸运四宫格抽奖</div>
                <div class="lottery-grid" id="lotteryGrid">
                    <!-- 四宫格将通过JavaScript动态生成 -->
                </div>
            </div>
            <div class="lottery-btn-container">
                <button class="spin-btn" id="spinBtn" onclick="startLottery()">开始抽奖</button>
            </div>
            <div id="resultMessage"></div>
        </div>
        
        <!-- 管理员主页面 -->
        <div id="adminSection" class="section">
            <div class="user-info">
                <h3>管理员面板</h3>
                <p>欢迎，管理员！</p>
            </div>
            
            <div class="nav">
                <button class="nav-btn active" onclick="showAdminTab('stats')">数据统计</button>
                <button class="nav-btn" onclick="showAdminTab('records')">全部记录</button>
                <button class="nav-btn" onclick="showAdminTab('whitelist')">白名单</button>
                <button class="nav-btn" onclick="showAdminTab('prizes')">奖品设置</button>
                <button class="nav-btn" onclick="showAdminTab('settings')">系统设置</button>
                <button class="nav-btn" onclick="showAdminTab('github')">GitHub存储</button>
            </div>
            
            <!-- 数据统计页面 -->
            <div id="statsTab" class="admin-section active">
                <h3>抽奖数据统计</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">总用户数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="participatedUsers">0</div>
                        <div class="stat-label">已参与用户</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalPrizes">0</div>
                        <div class="stat-label">总中奖数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="participationRate">0%</div>
                        <div class="stat-label">参与率</div>
                    </div>
                </div>
                <button class="btn btn-export" onclick="exportAllData()">导出完整数据Excel</button>
            </div>
            
            <!-- 全部记录页面 -->
            <div id="allRecordsTab" class="admin-section">
                <h3>全部抽奖记录</h3>
                <button class="btn btn-export" onclick="exportRecords()">导出记录Excel</button>
                <button class="btn" onclick="syncToGitHub()" style="background: #238636; margin-top: 10px;">同步到GitHub</button>
                <div class="record-list" id="allRecordList">
                    <!-- 记录将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 白名单管理页面 -->
            <div id="whitelistTab" class="admin-section">
                <h3>白名单管理</h3>
                
                <button class="btn" onclick="showAddUserModal()">新增用户</button>
                
                <div class="upload-area">
                    <div class="upload-icon">📊</div>
                    <p>导入Excel白名单文件</p>
                    <p style="font-size: 12px; color: #666;">支持 .xlsx 格式，包含房号、姓名、手机号列</p>
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx, .xls" onchange="handleFileImport(this.files)">
                    <label for="excelFile" class="file-label">选择Excel文件</label>
                </div>
                
                <button class="btn btn-export" onclick="exportWhitelist()">导出白名单Excel</button>
                
                <div class="admin-panel">
                    <h4>当前白名单 (<span id="whitelistCount">0</span> 条)</h4>
                    <div class="record-list">
                        <table class="whitelist-table">
                            <thead>
                                <tr>
                                    <th>房号</th>
                                    <th>姓名</th>
                                    <th>手机号</th>
                                    <th>抽奖状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="whitelistTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 奖品设置页面 -->
            <div id="prizesTab" class="admin-section">
                <h3>奖品设置</h3>
                
                <button class="btn" onclick="showAddPrizeModal()">新增奖品</button>
                
                <div class="admin-panel">
                    <h4>奖品列表 (<span id="prizesCount">0</span> 个)</h4>
                    <div class="record-list">
                        <table class="prizes-table">
                            <thead>
                                <tr>
                                    <th>奖品名称</th>
                                    <th>奖品数量</th>
                                    <th>中奖概率</th>
                                    <th>已中奖数</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="prizesTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 系统设置页面 -->
            <div id="settingsTab" class="admin-section">
                <h3>系统设置</h3>
                
                <div class="admin-panel">
                    <h4>修改管理员密码</h4>
                    <div class="form-group">
                        <label for="newPassword">新密码</label>
                        <input type="password" id="newPassword" placeholder="请输入新密码">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">确认新密码</label>
                        <input type="password" id="confirmPassword" placeholder="请再次输入新密码">
                    </div>
                    <button class="btn" onclick="changePassword()">修改密码</button>
                </div>

                <div class="admin-panel" style="margin-top: 15px;">
                    <h4>数据管理</h4>
                    <button class="btn btn-danger" onclick="clearAllData()">清空所有数据</button>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">注意：此操作将清空所有抽奖记录和用户数据，请谨慎操作！</p>
                </div>
            </div>

            <!-- GitHub存储设置页面 -->
            <div id="githubTab" class="admin-section">
                <h3>GitHub存储设置</h3>
                
                <div class="github-config">
                    <h4>GitHub配置</h4>
                    <div class="form-group">
                        <label for="githubToken">GitHub Personal Access Token</label>
                        <input type="password" id="githubToken" placeholder="请输入GitHub Token">
                        <p style="font-size: 12px; color: #666;">需要repo权限，用于读写仓库</p>
                    </div>
                    <div class="form-group">
                        <label for="githubRepo">仓库名称</label>
                        <input type="text" id="githubRepo" placeholder="例如：xiaoyuan2019/poly-lottery" value="xiaoyuan2019/poly-lottery">
                    </div>
                    <div class="form-group">
                        <label for="githubBranch">分支名称</label>
                        <input type="text" id="githubBranch" placeholder="例如：main" value="main">
                    </div>
                    <button class="btn" onclick="saveGitHubConfig()" style="background: #238636;">保存GitHub配置</button>
                    <button class="btn" onclick="testGitHubConnection()">测试连接</button>
                </div>

                <div class="admin-panel" style="margin-top: 15px;">
                    <h4>数据同步</h4>
                    <button class="btn" onclick="syncToGitHub()" style="background: #238636;">立即同步到GitHub</button>
                    <button class="btn" onclick="loadFromGitHub()">从GitHub加载</button>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        自动同步：每次抽奖后自动保存到GitHub<br>
                        手动同步：点击按钮立即同步所有数据
                    </p>
                </div>

                <div class="admin-panel" style="margin-top: 15px;">
                    <h4>GitHub文件查看</h4>
                    <p>数据文件位置：</p>
                    <ul style="font-size: 12px; color: #666;">
                        <li><code>data/lottery-records.xlsx</code> - <strong>仅包含已脱敏的抽奖记录</strong></li>
                    </ul>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        <strong>注意：</strong>GitHub只存储已脱敏的抽奖记录，不包含白名单和奖品设置信息
                    </p>
                    <button class="btn" onclick="openGitHubRepo()" style="background: #6e5494; margin-top: 10px;">打开GitHub仓库</button>
                </div>
            </div>
            
            <button class="btn" onclick="logout()" style="background: #95a5a6; margin-top: 20px;">退出管理员</button>
        </div>
    </div>

    <!-- 新增用户模态框 -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h3 id="userModalTitle">新增用户</h3>
            <div class="form-group">
                <label for="modalRoomNumber">房号</label>
                <input type="text" id="modalRoomNumber" placeholder="请输入房号">
            </div>
            <div class="form-group">
                <label for="modalUserName">姓名</label>
                <input type="text" id="modalUserName" placeholder="请输入姓名">
            </div>
            <div class="form-group">
                <label for="modalUserPhone">手机号</label>
                <input type="text" id="modalUserPhone" placeholder="请输入手机号">
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="saveUser()">保存</button>
                <button class="btn" onclick="closeModal('addUserModal')" style="background: #95a5a6;">取消</button>
            </div>
        </div>
    </div>

    <!-- 新增奖品模态框 -->
    <div id="addPrizeModal" class="modal">
        <div class="modal-content">
            <h3 id="prizeModalTitle">新增奖品</h3>
            <div class="form-group">
                <label for="modalPrizeName">奖品名称</label>
                <input type="text" id="modalPrizeName" placeholder="请输入奖品名称">
            </div>
            <div class="form-group">
                <label for="modalPrizeQuantity">奖品数量</label>
                <input type="number" id="modalPrizeQuantity" placeholder="请输入奖品数量" min="1">
            </div>
            <div class="form-group">
                <label for="modalPrizeProbability">中奖概率 (%)</label>
                <input type="number" id="modalPrizeProbability" placeholder="请输入中奖概率" min="0" max="100" step="0.1">
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="savePrize()">保存</button>
                <button class="btn" onclick="closeModal('addPrizeModal')" style="background: #95a5a6;">取消</button>
            </div>
        </div>
    </div>

    <script>
        // 数据存储键名
        const STORAGE_KEYS = {
            WHITELIST: 'lottery_whitelist',
            PRIZES: 'lottery_prizes',
            RECORDS: 'lottery_records',
            USED_ROOMS: 'lottery_used_rooms',
            ADMIN_PASSWORD: 'lottery_admin_password',
            CURRENT_USER: 'lottery_current_user',
            GITHUB_CONFIG: 'lottery_github_config'
        };

        // 初始化变量
        const gridColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
        let currentUser = null;
        let whitelist = [];
        let prizes = [];
        let lotteryRecords = [];
        let usedRooms = [];
        let isSpinning = false;
        let editingUserIndex = -1;
        let editingPrizeIndex = -1;
        let adminPassword = localStorage.getItem(STORAGE_KEYS.ADMIN_PASSWORD) || 'kB5nM3eU7vN3pO4i';

        // GitHub配置
        let githubConfig = {
            token: '',
            repo: 'xiaoyuan2019/poly-lottery',
            branch: 'main'
        };

        // 手机号脱敏处理
        function maskPhone(phone) {
            if (!phone || phone.length < 7) return 'xxxx';
            // 显示前3位和后4位，中间用****代替
            return phone.substring(0, 3) + '****' + phone.substring(7);
        }

        // 获取脱敏的抽奖记录（用于GitHub上传）
        function getMaskedRecords() {
            return lotteryRecords.map(record => ({
                timestamp: record.timestamp,
                roomNumber: record.roomNumber,
                name: record.name,
                phone: maskPhone(record.phone), // 脱敏处理
                prize: record.prize
            }));
        }

        // 初始化数据
        function initializeData() {
            console.log('正在初始化数据...');
            
            // 从localStorage加载数据
            const savedWhitelist = localStorage.getItem(STORAGE_KEYS.WHITELIST);
            const savedPrizes = localStorage.getItem(STORAGE_KEYS.PRIZES);
            const savedRecords = localStorage.getItem(STORAGE_KEYS.RECORDS);
            const savedUsedRooms = localStorage.getItem(STORAGE_KEYS.USED_ROOMS);
            const savedCurrentUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
            const savedGitHubConfig = localStorage.getItem(STORAGE_KEYS.GITHUB_CONFIG);
            
            // 加载GitHub配置
            if (savedGitHubConfig) {
                githubConfig = { ...githubConfig, ...JSON.parse(savedGitHubConfig) };
                document.getElementById('githubToken').value = githubConfig.token || '';
                document.getElementById('githubRepo').value = githubConfig.repo;
                document.getElementById('githubBranch').value = githubConfig.branch;
            }
            
            whitelist = savedWhitelist ? JSON.parse(savedWhitelist) : [
                { roomNumber: "k10-1-1-101", name: "张三", phone: "13800138001" },
                { roomNumber: "k10-1-1-102", name: "李四", phone: "13800138002" },
                { roomNumber: "k10-1-2-101", name: "王五", phone: "13800138003" },
                { roomNumber: "k10-1-2-102", name: "赵六", phone: "13800138004" }
            ];
            
            prizes = savedPrizes ? JSON.parse(savedPrizes) : [
                { name: "一等奖", quantity: 1, probability: 10, won: 0 },
                { name: "二等奖", quantity: 2, probability: 20, won: 0 },
                { name: "三等奖", quantity: 3, probability: 30, won: 0 },
                { name: "谢谢参与", quantity: 9999, probability: 40, won: 0 }
            ];
            
            lotteryRecords = savedRecords ? JSON.parse(savedRecords) : [];
            usedRooms = savedUsedRooms ? JSON.parse(savedUsedRooms) : [];
            
            // 恢复当前用户状态
            if (savedCurrentUser) {
                currentUser = JSON.parse(savedCurrentUser);
                const userExists = whitelist.find(u => u.roomNumber === currentUser.roomNumber);
                if (userExists) {
                    setTimeout(() => showMainSection(), 100);
                } else {
                    currentUser = null;
                    localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                }
            }
            
            saveAllData();
            console.log('初始化完成，当前记录数:', lotteryRecords.length);
        }

        // 保存所有数据到localStorage
        function saveAllData() {
            try {
                localStorage.setItem(STORAGE_KEYS.WHITELIST, JSON.stringify(whitelist));
                localStorage.setItem(STORAGE_KEYS.PRIZES, JSON.stringify(prizes));
                localStorage.setItem(STORAGE_KEYS.RECORDS, JSON.stringify(lotteryRecords));
                localStorage.setItem(STORAGE_KEYS.USED_ROOMS, JSON.stringify(usedRooms));
                localStorage.setItem(STORAGE_KEYS.GITHUB_CONFIG, JSON.stringify(githubConfig));
                if (currentUser) {
                    localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                }
                console.log('数据保存成功，记录数:', lotteryRecords.length);
            } catch (error) {
                console.error('保存数据失败:', error);
            }
        }

        // 确保始终包含谢谢参与奖项
        function ensureThankYouPrize() {
            const hasThankYou = prizes.some(prize => prize.name === '谢谢参与');
            if (!hasThankYou) {
                prizes.push({ name: "谢谢参与", quantity: 9999, probability: 40, won: 0 });
                saveAllData();
            }
        }

        // 初始化四宫格
        function initLotteryGrid() {
            const grid = document.getElementById('lotteryGrid');
            grid.innerHTML = '';
            
            // 确保包含谢谢参与
            ensureThankYouPrize();
            
            // 动态设置网格布局
            const prizeCount = prizes.length;
            const columns = Math.ceil(Math.sqrt(prizeCount));
            const rows = Math.ceil(prizeCount / columns);
            
            grid.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
            grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            grid.style.maxWidth = `${columns * 140}px`;
            
            prizes.forEach((prize, index) => {
                const item = document.createElement('div');
                item.className = `grid-item ${prize.name === '谢谢参与' ? 'thank' : ''}`;
                item.style.background = prize.name === '谢谢参与' 
                    ? 'linear-gradient(135deg, #95a5a6, #7f8c8d)'
                    : `linear-gradient(135deg, ${gridColors[index % gridColors.length]}, ${adjustColor(gridColors[index % gridColors.length], -20)})`;
                item.innerHTML = `<div>${prize.name}</div>`;
                item.dataset.index = index;
                grid.appendChild(item);
            });
        }

        // 调整颜色亮度
        function adjustColor(color, amount) {
            return '#' + color.replace(/^#/, '').replace(/../g, color => 
                ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2)
            );
        }

        // 验证用户登录
        function verifyUser() {
            const roomNumber = document.getElementById('roomNumber').value.trim();
            
            if (!roomNumber) {
                alert('请输入房号');
                return;
            }
            
            const user = whitelist.find(u => u.roomNumber === roomNumber);
            
            if (!user) {
                alert('房号不存在或未在白名单中');
                return;
            }
            
            if (usedRooms.includes(roomNumber)) {
                alert('该房号已参与过抽奖，每个房号仅限一次');
                return;
            }
            
            currentUser = user;
            saveAllData(); // 立即保存当前用户状态
            showMainSection();
        }

        // 显示管理员登录
        function showAdminLogin() {
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('adminLoginSection').classList.add('active');
        }

        // 验证管理员登录
        function verifyAdmin() {
            const account = document.getElementById('adminAccount').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (account === 'admin' && password === adminPassword) {
                document.getElementById('adminLoginSection').classList.remove('active');
                document.getElementById('adminSection').classList.add('active');
                updateAdminStats();
                updateWhitelistDisplay();
                updatePrizesDisplay();
                updateAllRecords();
            } else {
                alert('管理员账号或密码错误');
            }
        }

        // 返回主登录页面
        function backToMainLogin() {
            document.getElementById('adminLoginSection').classList.remove('active');
            document.getElementById('loginSection').classList.add('active');
        }

        // 显示主页面
        function showMainSection() {
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('mainSection').classList.add('active');
            
            document.getElementById('userWelcome').textContent = `欢迎，${currentUser.name}！`;
            document.getElementById('userDetails').textContent = 
                `房号：${currentUser.roomNumber} | 姓名：${currentUser.name} | 手机：${maskPhone(currentUser.phone)}`;
            
            initLotteryGrid();

            const spinBtn = document.getElementById('spinBtn');
            if (usedRooms.includes(currentUser.roomNumber)) {
                spinBtn.disabled = true;
                spinBtn.textContent = '已抽奖';
            } else {
                spinBtn.disabled = false;
                spinBtn.textContent = '开始抽奖';
            }
        }

        // 用户退出登录
        function userLogout() {
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
            document.getElementById('mainSection').classList.remove('active');
            document.getElementById('loginSection').classList.add('active');
            document.getElementById('roomNumber').value = '';
        }

        // 显示管理员标签页
        function showAdminTab(tabName) {
            // 修复：检查元素是否存在
            const navBtns = document.querySelectorAll('.nav-btn');
            if (navBtns.length === 0) return;
            
            navBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.admin-section').forEach(section => section.classList.remove('active'));
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }

        // 开始抽奖
        function startLottery() {
            if (usedRooms.includes(currentUser.roomNumber) || isSpinning) return;
            
            const gridItems = document.querySelectorAll('.grid-item');
            const spinBtn = document.getElementById('spinBtn');
            const resultDiv = document.getElementById('resultMessage');
            
            isSpinning = true;
            spinBtn.disabled = true;
            spinBtn.textContent = '抽奖中...';
            resultDiv.innerHTML = '';
            
            // 清除之前的高亮
            gridItems.forEach(item => item.classList.remove('active'));
            
            // 抽奖动画
            let count = 0;
            const totalRounds = 15 + Math.floor(Math.random() * 10);
            let currentIndex = 0;
            
            const interval = setInterval(() => {
                gridItems.forEach(item => item.classList.remove('active'));
                gridItems[currentIndex].classList.add('active');
                
                currentIndex = (currentIndex + 1) % gridItems.length;
                count++;
                
                if (count >= totalRounds) {
                    clearInterval(interval);
                    
                    // 确定中奖结果
                    const resultIndex = getRandomPrizeIndex();
                    gridItems.forEach(item => item.classList.remove('active'));
                    gridItems[resultIndex].classList.add('active');
                    
                    // 记录结果
                    setTimeout(() => {
                        const prize = prizes[resultIndex];
                        recordLotteryResult(prize);
                        isSpinning = false;
                        
                        if (!usedRooms.includes(currentUser.roomNumber)) {
                            spinBtn.disabled = false;
                            spinBtn.textContent = '开始抽奖';
                        }
                    }, 1000);
                }
            }, 150);
        }

        // 获取带权重的随机奖项
        function getRandomPrizeIndex() {
            const totalWeight = prizes.reduce((sum, prize) => sum + prize.probability, 0);
            let random = Math.random() * totalWeight;
            
            for (let i = 0; i < prizes.length; i++) {
                random -= prizes[i].probability;
                if (random <= 0) return i;
            }
            return prizes.length - 1;
        }

        // 记录抽奖结果
        function recordLotteryResult(prize) {
            console.log('开始记录抽奖结果...');
            
            // 检查奖品是否还有剩余
            if (prize.won >= prize.quantity && prize.name !== '谢谢参与') {
                const resultIndex = getRandomPrizeIndex();
                const newPrize = prizes[resultIndex];
                if (newPrize.won >= newPrize.quantity && newPrize.name !== '谢谢参与') {
                    prize = prizes.find(p => p.name === '谢谢参与');
                } else {
                    prize = newPrize;
                }
            }

            const record = {
                timestamp: new Date().toLocaleString('zh-CN'),
                roomNumber: currentUser.roomNumber,
                name: currentUser.name,
                phone: currentUser.phone,
                prize: prize.name
            };
            
            console.log('创建记录:', record);
            
            // 添加到记录数组
            lotteryRecords.unshift(record);
            usedRooms.push(currentUser.roomNumber);
            
            // 更新奖品中奖数量
            if (prize.name !== '谢谢参与') {
                const prizeIndex = prizes.findIndex(p => p.name === prize.name);
                if (prizeIndex !== -1) {
                    prizes[prizeIndex].won += 1;
                }
            }
            
            // 立即保存到localStorage
            saveAllData();
            
            // 新增：保存脱敏记录到GitHub
            saveToGitHub().then(success => {
                if (success) {
                    console.log('脱敏记录已保存到GitHub');
                } else {
                    console.log('GitHub保存失败，但本地记录已保存');
                }
            });

            const resultDiv = document.getElementById('resultMessage');
            resultDiv.className = prize.name === '谢谢参与' ? 'message error' : 'message success';
            resultDiv.innerHTML = prize.name === '谢谢参与' 
                ? `很遗憾，您获得了：${prize.name}`
                : `恭喜您！获得了：<strong>${prize.name}</strong>`;
            
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.disabled = true;
            spinBtn.textContent = '已抽奖';
            
            console.log('抽奖记录完成，总记录数:', lotteryRecords.length);
        }

        // 保存GitHub配置
        function saveGitHubConfig() {
            githubConfig.token = document.getElementById('githubToken').value.trim();
            githubConfig.repo = document.getElementById('githubRepo').value.trim();
            githubConfig.branch = document.getElementById('githubBranch').value.trim();
            
            if (!githubConfig.token || !githubConfig.repo) {
                alert('请填写完整的GitHub配置');
                return;
            }
            
            saveAllData();
            alert('GitHub配置保存成功');
        }

        // 测试GitHub连接
        async function testGitHubConnection() {
            if (!githubConfig.token) {
                alert('请先保存GitHub配置');
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    alert('GitHub连接成功！');
                } else {
                    alert('GitHub连接失败，请检查配置');
                }
            } catch (error) {
                alert('GitHub连接失败: ' + error.message);
            }
        }

        // 保存脱敏记录到GitHub
        async function saveToGitHub() {
            if (!githubConfig.token) {
                console.log('GitHub未配置，跳过保存');
                return false;
            }

            try {
                // 获取脱敏后的记录
                const maskedRecords = getMaskedRecords();
                
                // 创建抽奖记录Excel文件
                const recordsWorkbook = XLSX.utils.book_new();
                const recordsWorksheet = XLSX.utils.json_to_sheet(maskedRecords.map(record => ({
                    '时间': record.timestamp,
                    '房号': record.roomNumber,
                    '姓名': record.name,
                    '手机号': record.phone, // 这里已经是脱敏后的手机号
                    '奖项': record.prize
                })));
                XLSX.utils.book_append_sheet(recordsWorkbook, recordsWorksheet, '抽奖记录');
                const recordsExcelData = XLSX.write(recordsWorkbook, { bookType: 'xlsx', type: 'array' });

                // 更新文件到GitHub
                await updateExcelFileToGitHub('data/lottery-records.xlsx', recordsExcelData, '更新脱敏抽奖记录');
                
                console.log('脱敏记录已保存到GitHub');
                return true;
            } catch (error) {
                console.error('保存脱敏记录到GitHub失败:', error);
                return false;
            }
        }

        // 更新Excel文件到GitHub
        async function updateExcelFileToGitHub(path, excelData, commitMessage) {
            let sha = null;
            
            // 尝试获取现有文件的SHA
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/${path}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const fileData = await response.json();
                    sha = fileData.sha;
                }
            } catch (error) {
                // 文件不存在，继续创建
            }

            // 将Excel数据转换为base64
            const base64Data = btoa(String.fromCharCode(...new Uint8Array(excelData)));

            // 创建或更新文件
            const updateResponse = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${githubConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: base64Data,
                    branch: githubConfig.branch,
                    sha: sha
                })
            });

            if (!updateResponse.ok) {
                throw new Error('GitHub API请求失败');
            }
        }

        // 同步数据到GitHub - 只同步脱敏的抽奖记录
        async function syncToGitHub() {
            if (!githubConfig.token) {
                alert('请先配置GitHub Token');
                return;
            }

            try {
                await saveToGitHub();
                alert('脱敏抽奖记录同步到GitHub成功！');
            } catch (error) {
                alert('同步失败: ' + error.message);
            }
        }

        // 从GitHub加载数据（只加载抽奖记录）
        async function loadFromGitHub() {
            if (!githubConfig.token) {
                alert('请先配置GitHub Token');
                return;
            }

            try {
                // 加载抽奖记录
                const recordsResponse = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/data/lottery-records.xlsx`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (recordsResponse.ok) {
                    const fileData = await recordsResponse.json();
                    const content = atob(fileData.content);
                    const workbook = XLSX.read(content, { type: 'binary' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // 转换回内部格式（注意：手机号已经是脱敏的）
                    lotteryRecords = jsonData.map(record => ({
                        timestamp: record['时间'],
                        roomNumber: record['房号'],
                        name: record['姓名'],
                        phone: record['手机号'], // 这里是从GitHub加载的脱敏手机号
                        prize: record['奖项']
                    }));
                    
                    // 更新已抽奖列表
                    usedRooms = [...new Set(lotteryRecords.map(record => record.roomNumber))];
                } else {
                    alert('GitHub文件不存在或无法访问');
                    return;
                }

                saveAllData();
                updateAllRecords();
                updateAdminStats();
                
                alert('从GitHub加载脱敏抽奖记录成功！');
            } catch (error) {
                alert('加载失败: ' + error.message);
            }
        }

        // 打开GitHub仓库
        function openGitHubRepo() {
            if (githubConfig.repo) {
                window.open(`https://github.com/${githubConfig.repo}`, '_blank');
            } else {
                alert('请先配置GitHub仓库');
            }
        }

        // 更新管理员统计
        function updateAdminStats() {
            const totalUsers = whitelist.length;
            const participatedUsers = usedRooms.length;
            const totalPrizes = lotteryRecords.filter(r => r.prize !== '谢谢参与').length;
            const participationRate = totalUsers > 0 ? Math.round((participatedUsers / totalUsers) * 100) : 0;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('participatedUsers').textContent = participatedUsers;
            document.getElementById('totalPrizes').textContent = totalPrizes;
            document.getElementById('participationRate').textContent = participationRate + '%';
        }

        // 更新全部记录
        function updateAllRecords() {
            const allRecordList = document.getElementById('allRecordList');
            console.log('更新记录显示，当前记录数:', lotteryRecords.length);
            
            if (lotteryRecords.length === 0) {
                allRecordList.innerHTML = '<div class="record-item">暂无抽奖记录</div>';
            } else {
                allRecordList.innerHTML = lotteryRecords.map(record => `
                    <div class="record-item">
                        <div class="record-info">
                            <span>${record.timestamp}</span>
                            <span>${record.roomNumber}</span>
                        </div>
                        <div class="record-info">
                            <span>${record.name}</span>
                            <span>${maskPhone(record.phone)}</span>
                        </div>
                        <div class="record-prize">${record.prize}</div>
                    </div>
                `).join('');
            }
        }

        // 更新白名单显示
        function updateWhitelistDisplay() {
            const whitelistTable = document.getElementById('whitelistTable');
            const whitelistCount = document.getElementById('whitelistCount');
            
            whitelistCount.textContent = whitelist.length;
            whitelistTable.innerHTML = whitelist.map((user, index) => `
                <tr>
                    <td>${user.roomNumber}</td>
                    <td>${user.name}</td>
                    <td>${user.phone}</td>
                    <td>${usedRooms.includes(user.roomNumber) ? '<span style="color: red;">已抽奖</span>' : '<span style="color: green;">未抽奖</span>'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-edit" onclick="editUser(${index})">编辑</button>
                        <button class="btn btn-reset" onclick="resetUserLottery('${user.roomNumber}')">重置抽奖</button>
                        <button class="btn btn-delete" onclick="deleteUser(${index})">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        // 重置用户抽奖状态
        function resetUserLottery(roomNumber) {
            if (confirm(`确定要重置房号 ${roomNumber} 的抽奖状态吗？`)) {
                // 从已抽奖列表中移除
                const index = usedRooms.indexOf(roomNumber);
                if (index > -1) {
                    usedRooms.splice(index, 1);
                }
                
                // 保存数据
                saveAllData();
                
                // 更新显示
                updateWhitelistDisplay();
                updateAdminStats();
                
                alert('重置成功！该用户可以重新抽奖。');
            }
        }

        // 更新奖品显示
        function updatePrizesDisplay() {
            const prizesTable = document.getElementById('prizesTable');
            const prizesCount = document.getElementById('prizesCount');
            
            prizesCount.textContent = prizes.length;
            prizesTable.innerHTML = prizes.map((prize, index) => `
                <tr>
                    <td>${prize.name}</td>
                    <td>${prize.quantity}</td>
                    <td>${prize.probability}%</td>
                    <td>${prize.won}</td>
                    <td class="action-buttons">
                        <button class="btn btn-edit" onclick="editPrize(${index})">编辑</button>
                        <button class="btn btn-delete" onclick="deletePrize(${index})">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        // 显示新增用户模态框
        function showAddUserModal() {
            editingUserIndex = -1;
            document.getElementById('userModalTitle').textContent = '新增用户';
            document.getElementById('modalRoomNumber').value = '';
            document.getElementById('modalUserName').value = '';
            document.getElementById('modalUserPhone').value = '';
            document.getElementById('addUserModal').style.display = 'block';
        }

        // 编辑用户
        function editUser(index) {
            editingUserIndex = index;
            const user = whitelist[index];
            document.getElementById('userModalTitle').textContent = '编辑用户';
            document.getElementById('modalRoomNumber').value = user.roomNumber;
            document.getElementById('modalUserName').value = user.name;
            document.getElementById('modalUserPhone').value = user.phone;
            document.getElementById('addUserModal').style.display = 'block';
        }

        // 保存用户
        function saveUser() {
            const roomNumber = document.getElementById('modalRoomNumber').value.trim();
            const name = document.getElementById('modalUserName').value.trim();
            const phone = document.getElementById('modalUserPhone').value.trim();
            
            if (!roomNumber || !name || !phone) {
                alert('请填写完整信息');
                return;
            }
            
            if (editingUserIndex === -1) {
                // 新增用户
                whitelist.push({ roomNumber, name, phone });
            } else {
                // 编辑用户
                whitelist[editingUserIndex] = { roomNumber, name, phone };
            }
            
            saveAllData();
            updateWhitelistDisplay();
            closeModal('addUserModal');
        }

        // 删除用户
        function deleteUser(index) {
            if (confirm('确定要删除这个用户吗？')) {
                const user = whitelist[index];
                // 同时从已抽奖列表中移除
                const usedIndex = usedRooms.indexOf(user.roomNumber);
                if (usedIndex > -1) {
                    usedRooms.splice(usedIndex, 1);
                }
                
                whitelist.splice(index, 1);
                saveAllData();
                updateWhitelistDisplay();
            }
        }

        // 显示新增奖品模态框
        function showAddPrizeModal() {
            editingPrizeIndex = -1;
            document.getElementById('prizeModalTitle').textContent = '新增奖品';
            document.getElementById('modalPrizeName').value = '';
            document.getElementById('modalPrizeQuantity').value = '';
            document.getElementById('modalPrizeProbability').value = '';
            document.getElementById('addPrizeModal').style.display = 'block';
        }

        // 编辑奖品
        function editPrize(index) {
            editingPrizeIndex = index;
            const prize = prizes[index];
            document.getElementById('prizeModalTitle').textContent = '编辑奖品';
            document.getElementById('modalPrizeName').value = prize.name;
            document.getElementById('modalPrizeQuantity').value = prize.quantity;
            document.getElementById('modalPrizeProbability').value = prize.probability;
            document.getElementById('addPrizeModal').style.display = 'block';
        }

        // 保存奖品
        function savePrize() {
            const name = document.getElementById('modalPrizeName').value.trim();
            const quantity = parseInt(document.getElementById('modalPrizeQuantity').value);
            const probability = parseFloat(document.getElementById('modalPrizeProbability').value);
            
            if (!name || !quantity || !probability) {
                alert('请填写完整信息');
                return;
            }
            
            if (quantity < 1) {
                alert('奖品数量必须大于0');
                return;
            }
            
            if (probability < 0 || probability > 100) {
                alert('中奖概率必须在0-100之间');
                return;
            }
            
            if (editingPrizeIndex === -1) {
                // 新增奖品
                prizes.push({ name, quantity, probability, won: 0 });
            } else {
                // 编辑奖品
                prizes[editingPrizeIndex] = { 
                    name, 
                    quantity, 
                    probability, 
                    won: prizes[editingPrizeIndex].won 
                };
            }
            
            // 确保始终包含谢谢参与
            ensureThankYouPrize();
            
            saveAllData();
            updatePrizesDisplay();
            closeModal('addPrizeModal');
            
            // 重新初始化四宫格
            initLotteryGrid();
        }

        // 删除奖品 - 防止删除谢谢参与
        function deletePrize(index) {
            if (prizes[index].name === '谢谢参与') {
                alert('谢谢参与奖项不能删除');
                return;
            }
            
            if (confirm('确定要删除这个奖品吗？')) {
                prizes.splice(index, 1);
                saveAllData();
                updatePrizesDisplay();
                initLotteryGrid();
            }
        }

        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 处理Excel文件导入
        function handleFileImport(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // 验证数据格式
                    const validData = jsonData.filter(row => 
                        row.房号 && row.姓名 && row.手机号
                    );
                    
                    if (validData.length === 0) {
                        alert('Excel文件中未找到有效的白名单数据（需要包含房号、姓名、手机号列）');
                        return;
                    }
                    
                    // 转换数据格式
                    const newWhitelist = validData.map(row => ({
                        roomNumber: row.房号.toString(),
                        name: row.姓名.toString(),
                        phone: row.手机号.toString()
                    }));
                    
                    whitelist = newWhitelist;
                    saveAllData();
                    
                    updateWhitelistDisplay();
                    updateAdminStats();
                    
                    alert(`成功导入 ${newWhitelist.length} 条白名单数据`);
                    
                } catch (error) {
                    alert('文件读取失败，请检查文件格式');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 修改管理员密码
        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                alert('请填写完整信息');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('两次输入的密码不一致');
                return;
            }
            
            adminPassword = newPassword;
            localStorage.setItem(STORAGE_KEYS.ADMIN_PASSWORD, adminPassword);
            alert('密码修改成功');
            
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // 清空所有数据
        function clearAllData() {
            if (confirm('确定要清空所有数据吗？此操作不可恢复！')) {
                lotteryRecords = [];
                usedRooms = [];
                saveAllData();
                alert('数据已清空');
                updateAdminStats();
                updateAllRecords();
            }
        }

        // 导出抽奖记录
        function exportRecords() {
            const worksheet = XLSX.utils.json_to_sheet(lotteryRecords.map(record => ({
                '时间': record.timestamp,
                '房号': record.roomNumber,
                '姓名': record.name,
                '手机号': record.phone,
                '奖项': record.prize
            })));
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '抽奖记录');
            XLSX.writeFile(workbook, `抽奖记录_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 导出白名单
        function exportWhitelist() {
            const worksheet = XLSX.utils.json_to_sheet(whitelist.map(user => ({
                '房号': user.roomNumber,
                '姓名': user.name,
                '手机号': user.phone,
                '抽奖状态': usedRooms.includes(user.roomNumber) ? '已抽奖' : '未抽奖'
            })));
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '白名单');
            XLSX.writeFile(workbook, `白名单_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 导出完整数据
        function exportAllData() {
            const workbook = XLSX.utils.book_new();
            
            // 白名单sheet
            const whitelistSheet = XLSX.utils.json_to_sheet(whitelist.map(user => ({
                '房号': user.roomNumber,
                '姓名': user.name,
                '手机号': user.phone,
                '抽奖状态': usedRooms.includes(user.roomNumber) ? '已抽奖' : '未抽奖'
            })));
            XLSX.utils.book_append_sheet(workbook, whitelistSheet, '白名单');
            
            // 抽奖记录sheet
            const recordsSheet = XLSX.utils.json_to_sheet(lotteryRecords.map(record => ({
                '时间': record.timestamp,
                '房号': record.roomNumber,
                '姓名': record.name,
                '手机号': record.phone,
                '奖项': record.prize
            })));
            XLSX.utils.book_append_sheet(workbook, recordsSheet, '抽奖记录');
            
            // 统计数据sheet
            const statsData = [
                { '统计项': '总用户数', '数值': whitelist.length },
                { '统计项': '已参与用户', '数值': usedRooms.length },
                { '统计项': '总中奖数', '数值': lotteryRecords.filter(r => r.prize !== '谢谢参与').length },
                { '统计项': '参与率', '数值': whitelist.length > 0 ? Math.round((usedRooms.length / whitelist.length) * 100) + '%' : '0%' }
            ];
            const statsSheet = XLSX.utils.json_to_sheet(statsData);
            XLSX.utils.book_append_sheet(workbook, statsSheet, '统计数据');

            // 奖品设置sheet
            const prizesSheet = XLSX.utils.json_to_sheet(prizes.map(prize => ({
                '奖品名称': prize.name,
                '奖品数量': prize.quantity,
                '中奖概率': prize.probability + '%',
                '已中奖数': prize.won
            })));
            XLSX.utils.book_append_sheet(workbook, prizesSheet, '奖品设置');
            
            XLSX.writeFile(workbook, `抽奖系统完整数据_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 退出登录 - 不清理记录
        function logout() {
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
            document.getElementById('adminSection').classList.remove('active');
            document.getElementById('loginSection').classList.add('active');
            
            // 只清空输入框，不清理记录
            document.getElementById('roomNumber').value = '';
            document.getElementById('adminAccount').value = '';
            document.getElementById('adminPassword').value = '';
        }

        // 页面加载初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化数据
            initializeData();
            
            // 确保数据完整性
            ensureThankYouPrize();
            
            initLotteryGrid();
            
            // 添加页面刷新前的保存
            window.addEventListener('beforeunload', function() {
                saveAllData();
            });
        });
    </script>
</body>
</html>
