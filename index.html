<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>ä¿åˆ©ç‰©ä¸šæŠ½å¥–æ´»åŠ¨</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: #1a5fb4;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .logo {
            width: 150px;
            height: 50px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 20px;
        }
        
        .section {
            padding: 20px;
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #1a5fb4;
            outline: none;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: #1a5fb4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #154b8a;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-admin {
            background: #e74c3c;
            margin-top: 10px;
        }
        
        .btn-admin:hover {
            background: #c0392b;
        }
        
        .btn-export {
            background: #27ae60;
            margin-top: 10px;
        }
        
        .btn-export:hover {
            background: #219a52;
        }
        
        .btn-import {
            background: #f39c12;
            margin-top: 10px;
        }
        
        .btn-import:hover {
            background: #d68910;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-edit {
            background: #3498db;
            padding: 8px 15px;
            margin: 2px;
        }

        .btn-delete {
            background: #e74c3c;
            padding: 8px 15px;
            margin: 2px;
        }

        .btn-reset {
            background: #9b59b6;
            padding: 8px 15px;
            margin: 2px;
        }

        .btn-logout {
            background: #95a5a6;
            margin-top: 10px;
        }

        .btn-logout:hover {
            background: #7f8c8d;
        }

        /* å››å®«æ ¼æŠ½å¥–æ ·å¼ */
        .lottery-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px auto;
            max-width: 300px;
        }
        
        .grid-item {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #1a5fb4, #154b8a);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px;
            border: 3px solid transparent;
            box-shadow: 0 4px 15px rgba(26, 95, 180, 0.3);
        }
        
        .grid-item.active {
            background: linear-gradient(135deg, #ffd700, #ff6b6b);
            transform: scale(0.95);
            border-color: #ffd700;
            box-shadow: 0 0 20px gold;
            animation: pulse 0.5s ease-in-out;
        }
        
        .grid-item.thank {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(0.95); }
        }
        
        .lottery-container {
            position: relative;
            text-align: center;
        }
        
        .lottery-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        /* ä¸­å¥–è®°å½•æ ·å¼ */
        .record-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .record-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #1a5fb4;
        }
        
        .record-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        
        .record-prize {
            font-weight: bold;
            color: #1a5fb4;
            margin-top: 5px;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .nav {
            display: flex;
            justify-content: space-around;
            background: #f1f2f6;
            padding: 10px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 10px 15px;
            background: none;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            font-size: 14px;
            margin: 2px;
        }
        
        .nav-btn.active {
            background: #1a5fb4;
            color: white;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .success {
            background: #55efc4;
            color: #2d3436;
        }
        
        .error {
            background: #ff7675;
            color: white;
        }
        
        .lottery-btn-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .spin-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #1a5fb4, #154b8a);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(26, 95, 180, 0.4);
        }
        
        .spin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 95, 180, 0.6);
        }
        
        .spin-btn:disabled {
            background: #ccc;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        .format-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }
        
        .admin-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .admin-section {
            display: none;
        }
        
        .admin-section.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a5fb4;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: block;
            padding: 12px;
            background: #f39c12;
            color: white;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .whitelist-table, .prizes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .whitelist-table th, .whitelist-table td,
        .prizes-table th, .prizes-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .whitelist-table th, .prizes-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .upload-area {
            border: 2px dashed #1a5fb4;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            background: #f8f9fa;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #1a5fb4;
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        .github-config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div style="color: white; font-size: 24px; font-weight: bold;">ä¿åˆ©Â®ç‰©ä¸š</div>
            </div>
            <h2>å¹¸è¿å¤§è½¬ç›˜</h2>
        </div>
        
        <!-- ç™»å½•é¡µé¢ -->
        <div id="loginSection" class="section active">
            <div class="form-group">
                <input type="text" id="roomNumber" placeholder="è¯·è¾“å…¥æˆ¿å·ï¼Œä¾‹å¦‚ï¼šk10-1-1-101">
            </div>
            <div class="format-hint">æˆ¿å·æ ¼å¼ï¼šk10-1-1-101ï¼ˆæ¥¼æ ‹-å•å…ƒ-æ¥¼å±‚-æˆ¿å·ï¼‰</div>
            
            <button class="btn" onclick="verifyUser()">ä¸šä¸»ç™»å½•</button>
            <button class="btn btn-admin" onclick="showAdminLogin()">ç®¡ç†å‘˜ç™»å½•</button>
            
            <div class="message" style="background: #ffeaa7; color: #2d3436;">
                <p>æ¸©é¦¨æç¤ºï¼š</p>
                <p>1. è¯·è¾“å…¥æ­£ç¡®çš„æˆ¿å·è¿›è¡ŒéªŒè¯</p>
                <p>2. æ¯ä¸ªæˆ¿å·ä»…æœ‰ä¸€æ¬¡æŠ½å¥–æœºä¼š</p>
                <p>3. ä¸­å¥–ç»“æœä»¥ç³»ç»Ÿè®°å½•ä¸ºå‡†</p>
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜ç™»å½•é¡µé¢ -->
        <div id="adminLoginSection" class="section">
            <div class="form-group">
                <label for="adminAccount">ç®¡ç†å‘˜è´¦å·</label>
                <input type="text" id="adminAccount" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·">
            </div>
            <div class="form-group">
                <label for="adminPassword">ç®¡ç†å‘˜å¯†ç </label>
                <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
            </div>
            <button class="btn" onclick="verifyAdmin()">ç®¡ç†å‘˜ç™»å½•</button>
            <button class="btn" onclick="backToMainLogin()" style="background: #95a5a6; margin-top: 10px;">è¿”å›</button>
        </div>
        
        <!-- ä¸šä¸»ä¸»é¡µé¢ -->
        <div id="mainSection" class="section">
            <div class="user-info">
                <h3 id="userWelcome">æ¬¢è¿æ‚¨ï¼</h3>
                <p id="userDetails">æˆ¿å·ï¼š- | å§“åï¼š- | æ‰‹æœºï¼š-</p>
                <button class="btn btn-logout" onclick="userLogout()">é€€å‡ºç™»å½•</button>
            </div>
            
            <!-- ä¸šä¸»åªæœ‰æŠ½å¥–é¡µé¢ï¼Œæ²¡æœ‰è®°å½•é¡µé¢ -->
            <div class="lottery-container">
                <div class="lottery-title">å¹¸è¿å››å®«æ ¼æŠ½å¥–</div>
                <div class="lottery-grid" id="lotteryGrid">
                    <!-- å››å®«æ ¼å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="lottery-btn-container">
                <button class="spin-btn" id="spinBtn" onclick="startLottery()">å¼€å§‹æŠ½å¥–</button>
            </div>
            <div id="resultMessage"></div>
        </div>
        
        <!-- ç®¡ç†å‘˜ä¸»é¡µé¢ -->
        <div id="adminSection" class="section">
            <div class="user-info">
                <h3>ç®¡ç†å‘˜é¢æ¿</h3>
                <p>æ¬¢è¿ï¼Œç®¡ç†å‘˜ï¼</p>
            </div>
            
            <div class="nav">
                <button class="nav-btn active" onclick="showAdminTab('stats')">æ•°æ®ç»Ÿè®¡</button>
                <button class="nav-btn" onclick="showAdminTab('records')">å…¨éƒ¨è®°å½•</button>
                <button class="nav-btn" onclick="showAdminTab('whitelist')">ç™½åå•</button>
                <button class="nav-btn" onclick="showAdminTab('prizes')">å¥–å“è®¾ç½®</button>
                <button class="nav-btn" onclick="showAdminTab('settings')">ç³»ç»Ÿè®¾ç½®</button>
                <button class="nav-btn" onclick="showAdminTab('github')">GitHubå­˜å‚¨</button>
            </div>
            
            <!-- æ•°æ®ç»Ÿè®¡é¡µé¢ -->
            <div id="statsTab" class="admin-section active">
                <h3>æŠ½å¥–æ•°æ®ç»Ÿè®¡</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="participatedUsers">0</div>
                        <div class="stat-label">å·²å‚ä¸ç”¨æˆ·</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalPrizes">0</div>
                        <div class="stat-label">æ€»ä¸­å¥–æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="participationRate">0%</div>
                        <div class="stat-label">å‚ä¸ç‡</div>
                    </div>
                </div>
                <button class="btn btn-export" onclick="exportAllData()">å¯¼å‡ºå®Œæ•´æ•°æ®Excel</button>
            </div>
            
            <!-- å…¨éƒ¨è®°å½•é¡µé¢ -->
            <div id="allRecordsTab" class="admin-section">
                <h3>å…¨éƒ¨æŠ½å¥–è®°å½•</h3>
                <button class="btn btn-export" onclick="exportRecords()">å¯¼å‡ºè®°å½•Excel</button>
                <button class="btn" onclick="syncToGitHub()" style="background: #238636; margin-top: 10px;">åŒæ­¥åˆ°GitHub</button>
                <div class="record-list" id="allRecordList">
                    <!-- è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- ç™½åå•ç®¡ç†é¡µé¢ -->
            <div id="whitelistTab" class="admin-section">
                <h3>ç™½åå•ç®¡ç†</h3>
                
                <button class="btn" onclick="showAddUserModal()">æ–°å¢ç”¨æˆ·</button>
                
                <div class="upload-area">
                    <div class="upload-icon">ğŸ“Š</div>
                    <p>å¯¼å…¥Excelç™½åå•æ–‡ä»¶</p>
                    <p style="font-size: 12px; color: #666;">æ”¯æŒ .xlsx æ ¼å¼ï¼ŒåŒ…å«æˆ¿å·ã€å§“åã€æ‰‹æœºå·åˆ—</p>
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx, .xls" onchange="handleFileImport(this.files)">
                    <label for="excelFile" class="file-label">é€‰æ‹©Excelæ–‡ä»¶</label>
                </div>
                
                <button class="btn btn-export" onclick="exportWhitelist()">å¯¼å‡ºç™½åå•Excel</button>
                
                <div class="admin-panel">
                    <h4>å½“å‰ç™½åå• (<span id="whitelistCount">0</span> æ¡)</h4>
                    <div class="record-list">
                        <table class="whitelist-table">
                            <thead>
                                <tr>
                                    <th>æˆ¿å·</th>
                                    <th>å§“å</th>
                                    <th>æ‰‹æœºå·</th>
                                    <th>æŠ½å¥–çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="whitelistTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å¥–å“è®¾ç½®é¡µé¢ -->
            <div id="prizesTab" class="admin-section">
                <h3>å¥–å“è®¾ç½®</h3>
                
                <button class="btn" onclick="showAddPrizeModal()">æ–°å¢å¥–å“</button>
                
                <div class="admin-panel">
                    <h4>å¥–å“åˆ—è¡¨ (<span id="prizesCount">0</span> ä¸ª)</h4>
                    <div class="record-list">
                        <table class="prizes-table">
                            <thead>
                                <tr>
                                    <th>å¥–å“åç§°</th>
                                    <th>å¥–å“æ•°é‡</th>
                                    <th>ä¸­å¥–æ¦‚ç‡</th>
                                    <th>å·²ä¸­å¥–æ•°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="prizesTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»Ÿè®¾ç½®é¡µé¢ -->
            <div id="settingsTab" class="admin-section">
                <h3>ç³»ç»Ÿè®¾ç½®</h3>
                
                <div class="admin-panel">
                    <h4>ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </h4>
                    <div class="form-group">
                        <label for="newPassword">æ–°å¯†ç </label>
                        <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">ç¡®è®¤æ–°å¯†ç </label>
                        <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                    </div>
                    <button class="btn" onclick="changePassword()">ä¿®æ”¹å¯†ç </button>
                </div>

                <div class="admin-panel" style="margin-top: 15px;">
                    <h4>æ•°æ®ç®¡ç†</h4>
                    <button class="btn btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">æ³¨æ„ï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æŠ½å¥–è®°å½•å’Œç”¨æˆ·æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œï¼</p>
                </div>
            </div>

            <!-- GitHubå­˜å‚¨è®¾ç½®é¡µé¢ -->
            <div id="githubTab" class="admin-section">
                <h3>GitHubå­˜å‚¨è®¾ç½®</h3>
                
                <div class="github-config">
                    <h4>GitHubé…ç½®</h4>
                    <div class="form-group">
                        <label for="githubToken">GitHub Personal Access Token</label>
                        <input type="password" id="githubToken" placeholder="è¯·è¾“å…¥GitHub Token">
                        <p style="font-size: 12px; color: #666;">éœ€è¦repoæƒé™ï¼Œç”¨äºè¯»å†™ä»“åº“</p>
                    </div>
                    <div class="form-group">
                        <label for="githubRepo">ä»“åº“åç§°</label>
                        <input type="text" id="githubRepo" placeholder="ä¾‹å¦‚ï¼šxiaoyuan2019/poly-lottery" value="xiaoyuan2019/poly-lottery">
                    </div>
                    <div class="form-group">
                        <label for="githubBranch">åˆ†æ”¯åç§°</label>
                        <input type="text" id="githubBranch" placeholder="ä¾‹å¦‚ï¼šmain" value="main">
                    </div>
                    <button class="btn" onclick="saveGitHubConfig()" style="background: #238636;">ä¿å­˜GitHubé…ç½®</button>
                    <button class="btn" onclick="testGitHubConnection()">æµ‹è¯•è¿æ¥</button>
                </div>

                <div class="admin-panel" style="margin-top: 15px;">
                    <h4>æ•°æ®åŒæ­¥</h4>
                    <button class="btn" onclick="syncToGitHub()" style="background: #238636;">ç«‹å³åŒæ­¥åˆ°GitHub</button>
                    <button class="btn" onclick="loadFromGitHub()">ä»GitHubåŠ è½½</button>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        è‡ªåŠ¨åŒæ­¥ï¼šæ¯æ¬¡æŠ½å¥–åè‡ªåŠ¨ä¿å­˜åˆ°GitHub<br>
                        æ‰‹åŠ¨åŒæ­¥ï¼šç‚¹å‡»æŒ‰é’®ç«‹å³åŒæ­¥æ‰€æœ‰æ•°æ®
                    </p>
                </div>

                <div class="admin-panel" style="margin-top: 15px;">
                    <h4>GitHubæ–‡ä»¶æŸ¥çœ‹</h4>
                    <p>æ•°æ®æ–‡ä»¶ä½ç½®ï¼š</p>
                    <ul style="font-size: 12px; color: #666;">
                        <li><code>data/lottery-records.xlsx</code> - <strong>ä»…åŒ…å«å·²è„±æ•çš„æŠ½å¥–è®°å½•</strong></li>
                    </ul>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        <strong>æ³¨æ„ï¼š</strong>GitHubåªå­˜å‚¨å·²è„±æ•çš„æŠ½å¥–è®°å½•ï¼Œä¸åŒ…å«ç™½åå•å’Œå¥–å“è®¾ç½®ä¿¡æ¯
                    </p>
                    <button class="btn" onclick="openGitHubRepo()" style="background: #6e5494; margin-top: 10px;">æ‰“å¼€GitHubä»“åº“</button>
                </div>
            </div>
            
            <button class="btn" onclick="logout()" style="background: #95a5a6; margin-top: 20px;">é€€å‡ºç®¡ç†å‘˜</button>
        </div>
    </div>

    <!-- æ–°å¢ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h3 id="userModalTitle">æ–°å¢ç”¨æˆ·</h3>
            <div class="form-group">
                <label for="modalRoomNumber">æˆ¿å·</label>
                <input type="text" id="modalRoomNumber" placeholder="è¯·è¾“å…¥æˆ¿å·">
            </div>
            <div class="form-group">
                <label for="modalUserName">å§“å</label>
                <input type="text" id="modalUserName" placeholder="è¯·è¾“å…¥å§“å">
            </div>
            <div class="form-group">
                <label for="modalUserPhone">æ‰‹æœºå·</label>
                <input type="text" id="modalUserPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="saveUser()">ä¿å­˜</button>
                <button class="btn" onclick="closeModal('addUserModal')" style="background: #95a5a6;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢å¥–å“æ¨¡æ€æ¡† -->
    <div id="addPrizeModal" class="modal">
        <div class="modal-content">
            <h3 id="prizeModalTitle">æ–°å¢å¥–å“</h3>
            <div class="form-group">
                <label for="modalPrizeName">å¥–å“åç§°</label>
                <input type="text" id="modalPrizeName" placeholder="è¯·è¾“å…¥å¥–å“åç§°">
            </div>
            <div class="form-group">
                <label for="modalPrizeQuantity">å¥–å“æ•°é‡</label>
                <input type="number" id="modalPrizeQuantity" placeholder="è¯·è¾“å…¥å¥–å“æ•°é‡" min="1">
            </div>
            <div class="form-group">
                <label for="modalPrizeProbability">ä¸­å¥–æ¦‚ç‡ (%)</label>
                <input type="number" id="modalPrizeProbability" placeholder="è¯·è¾“å…¥ä¸­å¥–æ¦‚ç‡" min="0" max="100" step="0.1">
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="savePrize()">ä¿å­˜</button>
                <button class="btn" onclick="closeModal('addPrizeModal')" style="background: #95a5a6;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨é”®å
        const STORAGE_KEYS = {
            WHITELIST: 'lottery_whitelist',
            PRIZES: 'lottery_prizes',
            RECORDS: 'lottery_records',
            USED_ROOMS: 'lottery_used_rooms',
            ADMIN_PASSWORD: 'lottery_admin_password',
            CURRENT_USER: 'lottery_current_user',
            GITHUB_CONFIG: 'lottery_github_config'
        };

        // åˆå§‹åŒ–å˜é‡
        const gridColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
        let currentUser = null;
        let whitelist = [];
        let prizes = [];
        let lotteryRecords = [];
        let usedRooms = [];
        let isSpinning = false;
        let editingUserIndex = -1;
        let editingPrizeIndex = -1;
        let adminPassword = localStorage.getItem(STORAGE_KEYS.ADMIN_PASSWORD) || 'kB5nM3eU7vN3pO4i';

        // GitHubé…ç½®
        let githubConfig = {
            token: '',
            repo: 'xiaoyuan2019/poly-lottery',
            branch: 'main'
        };

        // æ‰‹æœºå·è„±æ•å¤„ç†
        function maskPhone(phone) {
            if (!phone || phone.length < 7) return 'xxxx';
            // æ˜¾ç¤ºå‰3ä½å’Œå4ä½ï¼Œä¸­é—´ç”¨****ä»£æ›¿
            return phone.substring(0, 3) + '****' + phone.substring(7);
        }

        // è·å–è„±æ•çš„æŠ½å¥–è®°å½•ï¼ˆç”¨äºGitHubä¸Šä¼ ï¼‰
        function getMaskedRecords() {
            return lotteryRecords.map(record => ({
                timestamp: record.timestamp,
                roomNumber: record.roomNumber,
                name: record.name,
                phone: maskPhone(record.phone), // è„±æ•å¤„ç†
                prize: record.prize
            }));
        }

        // åˆå§‹åŒ–æ•°æ®
        function initializeData() {
            console.log('æ­£åœ¨åˆå§‹åŒ–æ•°æ®...');
            
            // ä»localStorageåŠ è½½æ•°æ®
            const savedWhitelist = localStorage.getItem(STORAGE_KEYS.WHITELIST);
            const savedPrizes = localStorage.getItem(STORAGE_KEYS.PRIZES);
            const savedRecords = localStorage.getItem(STORAGE_KEYS.RECORDS);
            const savedUsedRooms = localStorage.getItem(STORAGE_KEYS.USED_ROOMS);
            const savedCurrentUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
            const savedGitHubConfig = localStorage.getItem(STORAGE_KEYS.GITHUB_CONFIG);
            
            // åŠ è½½GitHubé…ç½®
            if (savedGitHubConfig) {
                githubConfig = { ...githubConfig, ...JSON.parse(savedGitHubConfig) };
                document.getElementById('githubToken').value = githubConfig.token || '';
                document.getElementById('githubRepo').value = githubConfig.repo;
                document.getElementById('githubBranch').value = githubConfig.branch;
            }
            
            whitelist = savedWhitelist ? JSON.parse(savedWhitelist) : [
                { roomNumber: "k10-1-1-101", name: "å¼ ä¸‰", phone: "13800138001" },
                { roomNumber: "k10-1-1-102", name: "æå››", phone: "13800138002" },
                { roomNumber: "k10-1-2-101", name: "ç‹äº”", phone: "13800138003" },
                { roomNumber: "k10-1-2-102", name: "èµµå…­", phone: "13800138004" }
            ];
            
            prizes = savedPrizes ? JSON.parse(savedPrizes) : [
                { name: "ä¸€ç­‰å¥–", quantity: 1, probability: 10, won: 0 },
                { name: "äºŒç­‰å¥–", quantity: 2, probability: 20, won: 0 },
                { name: "ä¸‰ç­‰å¥–", quantity: 3, probability: 30, won: 0 },
                { name: "è°¢è°¢å‚ä¸", quantity: 9999, probability: 40, won: 0 }
            ];
            
            lotteryRecords = savedRecords ? JSON.parse(savedRecords) : [];
            usedRooms = savedUsedRooms ? JSON.parse(savedUsedRooms) : [];
            
            // æ¢å¤å½“å‰ç”¨æˆ·çŠ¶æ€
            if (savedCurrentUser) {
                currentUser = JSON.parse(savedCurrentUser);
                const userExists = whitelist.find(u => u.roomNumber === currentUser.roomNumber);
                if (userExists) {
                    setTimeout(() => showMainSection(), 100);
                } else {
                    currentUser = null;
                    localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                }
            }
            
            saveAllData();
            console.log('åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰è®°å½•æ•°:', lotteryRecords.length);
        }

        // ä¿å­˜æ‰€æœ‰æ•°æ®åˆ°localStorage
        function saveAllData() {
            try {
                localStorage.setItem(STORAGE_KEYS.WHITELIST, JSON.stringify(whitelist));
                localStorage.setItem(STORAGE_KEYS.PRIZES, JSON.stringify(prizes));
                localStorage.setItem(STORAGE_KEYS.RECORDS, JSON.stringify(lotteryRecords));
                localStorage.setItem(STORAGE_KEYS.USED_ROOMS, JSON.stringify(usedRooms));
                localStorage.setItem(STORAGE_KEYS.GITHUB_CONFIG, JSON.stringify(githubConfig));
                if (currentUser) {
                    localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                }
                console.log('æ•°æ®ä¿å­˜æˆåŠŸï¼Œè®°å½•æ•°:', lotteryRecords.length);
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
            }
        }

        // ç¡®ä¿å§‹ç»ˆåŒ…å«è°¢è°¢å‚ä¸å¥–é¡¹
        function ensureThankYouPrize() {
            const hasThankYou = prizes.some(prize => prize.name === 'è°¢è°¢å‚ä¸');
            if (!hasThankYou) {
                prizes.push({ name: "è°¢è°¢å‚ä¸", quantity: 9999, probability: 40, won: 0 });
                saveAllData();
            }
        }

        // åˆå§‹åŒ–å››å®«æ ¼
        function initLotteryGrid() {
            const grid = document.getElementById('lotteryGrid');
            grid.innerHTML = '';
            
            // ç¡®ä¿åŒ…å«è°¢è°¢å‚ä¸
            ensureThankYouPrize();
            
            // åŠ¨æ€è®¾ç½®ç½‘æ ¼å¸ƒå±€
            const prizeCount = prizes.length;
            const columns = Math.ceil(Math.sqrt(prizeCount));
            const rows = Math.ceil(prizeCount / columns);
            
            grid.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
            grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            grid.style.maxWidth = `${columns * 140}px`;
            
            prizes.forEach((prize, index) => {
                const item = document.createElement('div');
                item.className = `grid-item ${prize.name === 'è°¢è°¢å‚ä¸' ? 'thank' : ''}`;
                item.style.background = prize.name === 'è°¢è°¢å‚ä¸' 
                    ? 'linear-gradient(135deg, #95a5a6, #7f8c8d)'
                    : `linear-gradient(135deg, ${gridColors[index % gridColors.length]}, ${adjustColor(gridColors[index % gridColors.length], -20)})`;
                item.innerHTML = `<div>${prize.name}</div>`;
                item.dataset.index = index;
                grid.appendChild(item);
            });
        }

        // è°ƒæ•´é¢œè‰²äº®åº¦
        function adjustColor(color, amount) {
            return '#' + color.replace(/^#/, '').replace(/../g, color => 
                ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2)
            );
        }

        // éªŒè¯ç”¨æˆ·ç™»å½•
        function verifyUser() {
            const roomNumber = document.getElementById('roomNumber').value.trim();
            
            if (!roomNumber) {
                alert('è¯·è¾“å…¥æˆ¿å·');
                return;
            }
            
            const user = whitelist.find(u => u.roomNumber === roomNumber);
            
            if (!user) {
                alert('æˆ¿å·ä¸å­˜åœ¨æˆ–æœªåœ¨ç™½åå•ä¸­');
                return;
            }
            
            if (usedRooms.includes(roomNumber)) {
                alert('è¯¥æˆ¿å·å·²å‚ä¸è¿‡æŠ½å¥–ï¼Œæ¯ä¸ªæˆ¿å·ä»…é™ä¸€æ¬¡');
                return;
            }
            
            currentUser = user;
            saveAllData(); // ç«‹å³ä¿å­˜å½“å‰ç”¨æˆ·çŠ¶æ€
            showMainSection();
        }

        // æ˜¾ç¤ºç®¡ç†å‘˜ç™»å½•
        function showAdminLogin() {
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('adminLoginSection').classList.add('active');
        }

        // éªŒè¯ç®¡ç†å‘˜ç™»å½•
        function verifyAdmin() {
            const account = document.getElementById('adminAccount').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (account === 'admin' && password === adminPassword) {
                document.getElementById('adminLoginSection').classList.remove('active');
                document.getElementById('adminSection').classList.add('active');
                updateAdminStats();
                updateWhitelistDisplay();
                updatePrizesDisplay();
                updateAllRecords();
            } else {
                alert('ç®¡ç†å‘˜è´¦å·æˆ–å¯†ç é”™è¯¯');
            }
        }

        // è¿”å›ä¸»ç™»å½•é¡µé¢
        function backToMainLogin() {
            document.getElementById('adminLoginSection').classList.remove('active');
            document.getElementById('loginSection').classList.add('active');
        }

        // æ˜¾ç¤ºä¸»é¡µé¢
        function showMainSection() {
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('mainSection').classList.add('active');
            
            document.getElementById('userWelcome').textContent = `æ¬¢è¿ï¼Œ${currentUser.name}ï¼`;
            document.getElementById('userDetails').textContent = 
                `æˆ¿å·ï¼š${currentUser.roomNumber} | å§“åï¼š${currentUser.name} | æ‰‹æœºï¼š${maskPhone(currentUser.phone)}`;
            
            initLotteryGrid();

            const spinBtn = document.getElementById('spinBtn');
            if (usedRooms.includes(currentUser.roomNumber)) {
                spinBtn.disabled = true;
                spinBtn.textContent = 'å·²æŠ½å¥–';
            } else {
                spinBtn.disabled = false;
                spinBtn.textContent = 'å¼€å§‹æŠ½å¥–';
            }
        }

        // ç”¨æˆ·é€€å‡ºç™»å½•
        function userLogout() {
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
            document.getElementById('mainSection').classList.remove('active');
            document.getElementById('loginSection').classList.add('active');
            document.getElementById('roomNumber').value = '';
        }

        // æ˜¾ç¤ºç®¡ç†å‘˜æ ‡ç­¾é¡µ
        function showAdminTab(tabName) {
            // ä¿®å¤ï¼šæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const navBtns = document.querySelectorAll('.nav-btn');
            if (navBtns.length === 0) return;
            
            navBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.admin-section').forEach(section => section.classList.remove('active'));
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }

        // å¼€å§‹æŠ½å¥–
        function startLottery() {
            if (usedRooms.includes(currentUser.roomNumber) || isSpinning) return;
            
            const gridItems = document.querySelectorAll('.grid-item');
            const spinBtn = document.getElementById('spinBtn');
            const resultDiv = document.getElementById('resultMessage');
            
            isSpinning = true;
            spinBtn.disabled = true;
            spinBtn.textContent = 'æŠ½å¥–ä¸­...';
            resultDiv.innerHTML = '';
            
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            gridItems.forEach(item => item.classList.remove('active'));
            
            // æŠ½å¥–åŠ¨ç”»
            let count = 0;
            const totalRounds = 15 + Math.floor(Math.random() * 10);
            let currentIndex = 0;
            
            const interval = setInterval(() => {
                gridItems.forEach(item => item.classList.remove('active'));
                gridItems[currentIndex].classList.add('active');
                
                currentIndex = (currentIndex + 1) % gridItems.length;
                count++;
                
                if (count >= totalRounds) {
                    clearInterval(interval);
                    
                    // ç¡®å®šä¸­å¥–ç»“æœ
                    const resultIndex = getRandomPrizeIndex();
                    gridItems.forEach(item => item.classList.remove('active'));
                    gridItems[resultIndex].classList.add('active');
                    
                    // è®°å½•ç»“æœ
                    setTimeout(() => {
                        const prize = prizes[resultIndex];
                        recordLotteryResult(prize);
                        isSpinning = false;
                        
                        if (!usedRooms.includes(currentUser.roomNumber)) {
                            spinBtn.disabled = false;
                            spinBtn.textContent = 'å¼€å§‹æŠ½å¥–';
                        }
                    }, 1000);
                }
            }, 150);
        }

        // è·å–å¸¦æƒé‡çš„éšæœºå¥–é¡¹
        function getRandomPrizeIndex() {
            const totalWeight = prizes.reduce((sum, prize) => sum + prize.probability, 0);
            let random = Math.random() * totalWeight;
            
            for (let i = 0; i < prizes.length; i++) {
                random -= prizes[i].probability;
                if (random <= 0) return i;
            }
            return prizes.length - 1;
        }

        // è®°å½•æŠ½å¥–ç»“æœ
        function recordLotteryResult(prize) {
            console.log('å¼€å§‹è®°å½•æŠ½å¥–ç»“æœ...');
            
            // æ£€æŸ¥å¥–å“æ˜¯å¦è¿˜æœ‰å‰©ä½™
            if (prize.won >= prize.quantity && prize.name !== 'è°¢è°¢å‚ä¸') {
                const resultIndex = getRandomPrizeIndex();
                const newPrize = prizes[resultIndex];
                if (newPrize.won >= newPrize.quantity && newPrize.name !== 'è°¢è°¢å‚ä¸') {
                    prize = prizes.find(p => p.name === 'è°¢è°¢å‚ä¸');
                } else {
                    prize = newPrize;
                }
            }

            const record = {
                timestamp: new Date().toLocaleString('zh-CN'),
                roomNumber: currentUser.roomNumber,
                name: currentUser.name,
                phone: currentUser.phone,
                prize: prize.name
            };
            
            console.log('åˆ›å»ºè®°å½•:', record);
            
            // æ·»åŠ åˆ°è®°å½•æ•°ç»„
            lotteryRecords.unshift(record);
            usedRooms.push(currentUser.roomNumber);
            
            // æ›´æ–°å¥–å“ä¸­å¥–æ•°é‡
            if (prize.name !== 'è°¢è°¢å‚ä¸') {
                const prizeIndex = prizes.findIndex(p => p.name === prize.name);
                if (prizeIndex !== -1) {
                    prizes[prizeIndex].won += 1;
                }
            }
            
            // ç«‹å³ä¿å­˜åˆ°localStorage
            saveAllData();
            
            // æ–°å¢ï¼šä¿å­˜è„±æ•è®°å½•åˆ°GitHub
            saveToGitHub().then(success => {
                if (success) {
                    console.log('è„±æ•è®°å½•å·²ä¿å­˜åˆ°GitHub');
                } else {
                    console.log('GitHubä¿å­˜å¤±è´¥ï¼Œä½†æœ¬åœ°è®°å½•å·²ä¿å­˜');
                }
            });

            const resultDiv = document.getElementById('resultMessage');
            resultDiv.className = prize.name === 'è°¢è°¢å‚ä¸' ? 'message error' : 'message success';
            resultDiv.innerHTML = prize.name === 'è°¢è°¢å‚ä¸' 
                ? `å¾ˆé—æ†¾ï¼Œæ‚¨è·å¾—äº†ï¼š${prize.name}`
                : `æ­å–œæ‚¨ï¼è·å¾—äº†ï¼š<strong>${prize.name}</strong>`;
            
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.disabled = true;
            spinBtn.textContent = 'å·²æŠ½å¥–';
            
            console.log('æŠ½å¥–è®°å½•å®Œæˆï¼Œæ€»è®°å½•æ•°:', lotteryRecords.length);
        }

        // ä¿å­˜GitHubé…ç½®
        function saveGitHubConfig() {
            githubConfig.token = document.getElementById('githubToken').value.trim();
            githubConfig.repo = document.getElementById('githubRepo').value.trim();
            githubConfig.branch = document.getElementById('githubBranch').value.trim();
            
            if (!githubConfig.token || !githubConfig.repo) {
                alert('è¯·å¡«å†™å®Œæ•´çš„GitHubé…ç½®');
                return;
            }
            
            saveAllData();
            alert('GitHubé…ç½®ä¿å­˜æˆåŠŸ');
        }

        // æµ‹è¯•GitHubè¿æ¥
        async function testGitHubConnection() {
            if (!githubConfig.token) {
                alert('è¯·å…ˆä¿å­˜GitHubé…ç½®');
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    alert('GitHubè¿æ¥æˆåŠŸï¼');
                } else {
                    alert('GitHubè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®');
                }
            } catch (error) {
                alert('GitHubè¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜è„±æ•è®°å½•åˆ°GitHub
        async function saveToGitHub() {
            if (!githubConfig.token) {
                console.log('GitHubæœªé…ç½®ï¼Œè·³è¿‡ä¿å­˜');
                return false;
            }

            try {
                // è·å–è„±æ•åçš„è®°å½•
                const maskedRecords = getMaskedRecords();
                
                // åˆ›å»ºæŠ½å¥–è®°å½•Excelæ–‡ä»¶
                const recordsWorkbook = XLSX.utils.book_new();
                const recordsWorksheet = XLSX.utils.json_to_sheet(maskedRecords.map(record => ({
                    'æ—¶é—´': record.timestamp,
                    'æˆ¿å·': record.roomNumber,
                    'å§“å': record.name,
                    'æ‰‹æœºå·': record.phone, // è¿™é‡Œå·²ç»æ˜¯è„±æ•åçš„æ‰‹æœºå·
                    'å¥–é¡¹': record.prize
                })));
                XLSX.utils.book_append_sheet(recordsWorkbook, recordsWorksheet, 'æŠ½å¥–è®°å½•');
                const recordsExcelData = XLSX.write(recordsWorkbook, { bookType: 'xlsx', type: 'array' });

                // æ›´æ–°æ–‡ä»¶åˆ°GitHub
                await updateExcelFileToGitHub('data/lottery-records.xlsx', recordsExcelData, 'æ›´æ–°è„±æ•æŠ½å¥–è®°å½•');
                
                console.log('è„±æ•è®°å½•å·²ä¿å­˜åˆ°GitHub');
                return true;
            } catch (error) {
                console.error('ä¿å­˜è„±æ•è®°å½•åˆ°GitHubå¤±è´¥:', error);
                return false;
            }
        }

        // æ›´æ–°Excelæ–‡ä»¶åˆ°GitHub
        async function updateExcelFileToGitHub(path, excelData, commitMessage) {
            let sha = null;
            
            // å°è¯•è·å–ç°æœ‰æ–‡ä»¶çš„SHA
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/${path}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const fileData = await response.json();
                    sha = fileData.sha;
                }
            } catch (error) {
                // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»§ç»­åˆ›å»º
            }

            // å°†Excelæ•°æ®è½¬æ¢ä¸ºbase64
            const base64Data = btoa(String.fromCharCode(...new Uint8Array(excelData)));

            // åˆ›å»ºæˆ–æ›´æ–°æ–‡ä»¶
            const updateResponse = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${githubConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: base64Data,
                    branch: githubConfig.branch,
                    sha: sha
                })
            });

            if (!updateResponse.ok) {
                throw new Error('GitHub APIè¯·æ±‚å¤±è´¥');
            }
        }

        // åŒæ­¥æ•°æ®åˆ°GitHub - åªåŒæ­¥è„±æ•çš„æŠ½å¥–è®°å½•
        async function syncToGitHub() {
            if (!githubConfig.token) {
                alert('è¯·å…ˆé…ç½®GitHub Token');
                return;
            }

            try {
                await saveToGitHub();
                alert('è„±æ•æŠ½å¥–è®°å½•åŒæ­¥åˆ°GitHubæˆåŠŸï¼');
            } catch (error) {
                alert('åŒæ­¥å¤±è´¥: ' + error.message);
            }
        }

        // ä»GitHubåŠ è½½æ•°æ®ï¼ˆåªåŠ è½½æŠ½å¥–è®°å½•ï¼‰
        async function loadFromGitHub() {
            if (!githubConfig.token) {
                alert('è¯·å…ˆé…ç½®GitHub Token');
                return;
            }

            try {
                // åŠ è½½æŠ½å¥–è®°å½•
                const recordsResponse = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/data/lottery-records.xlsx`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (recordsResponse.ok) {
                    const fileData = await recordsResponse.json();
                    const content = atob(fileData.content);
                    const workbook = XLSX.read(content, { type: 'binary' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // è½¬æ¢å›å†…éƒ¨æ ¼å¼ï¼ˆæ³¨æ„ï¼šæ‰‹æœºå·å·²ç»æ˜¯è„±æ•çš„ï¼‰
                    lotteryRecords = jsonData.map(record => ({
                        timestamp: record['æ—¶é—´'],
                        roomNumber: record['æˆ¿å·'],
                        name: record['å§“å'],
                        phone: record['æ‰‹æœºå·'], // è¿™é‡Œæ˜¯ä»GitHubåŠ è½½çš„è„±æ•æ‰‹æœºå·
                        prize: record['å¥–é¡¹']
                    }));
                    
                    // æ›´æ–°å·²æŠ½å¥–åˆ—è¡¨
                    usedRooms = [...new Set(lotteryRecords.map(record => record.roomNumber))];
                } else {
                    alert('GitHubæ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®');
                    return;
                }

                saveAllData();
                updateAllRecords();
                updateAdminStats();
                
                alert('ä»GitHubåŠ è½½è„±æ•æŠ½å¥–è®°å½•æˆåŠŸï¼');
            } catch (error) {
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // æ‰“å¼€GitHubä»“åº“
        function openGitHubRepo() {
            if (githubConfig.repo) {
                window.open(`https://github.com/${githubConfig.repo}`, '_blank');
            } else {
                alert('è¯·å…ˆé…ç½®GitHubä»“åº“');
            }
        }

        // æ›´æ–°ç®¡ç†å‘˜ç»Ÿè®¡
        function updateAdminStats() {
            const totalUsers = whitelist.length;
            const participatedUsers = usedRooms.length;
            const totalPrizes = lotteryRecords.filter(r => r.prize !== 'è°¢è°¢å‚ä¸').length;
            const participationRate = totalUsers > 0 ? Math.round((participatedUsers / totalUsers) * 100) : 0;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('participatedUsers').textContent = participatedUsers;
            document.getElementById('totalPrizes').textContent = totalPrizes;
            document.getElementById('participationRate').textContent = participationRate + '%';
        }

        // æ›´æ–°å…¨éƒ¨è®°å½•
        function updateAllRecords() {
            const allRecordList = document.getElementById('allRecordList');
            console.log('æ›´æ–°è®°å½•æ˜¾ç¤ºï¼Œå½“å‰è®°å½•æ•°:', lotteryRecords.length);
            
            if (lotteryRecords.length === 0) {
                allRecordList.innerHTML = '<div class="record-item">æš‚æ— æŠ½å¥–è®°å½•</div>';
            } else {
                allRecordList.innerHTML = lotteryRecords.map(record => `
                    <div class="record-item">
                        <div class="record-info">
                            <span>${record.timestamp}</span>
                            <span>${record.roomNumber}</span>
                        </div>
                        <div class="record-info">
                            <span>${record.name}</span>
                            <span>${maskPhone(record.phone)}</span>
                        </div>
                        <div class="record-prize">${record.prize}</div>
                    </div>
                `).join('');
            }
        }

        // æ›´æ–°ç™½åå•æ˜¾ç¤º
        function updateWhitelistDisplay() {
            const whitelistTable = document.getElementById('whitelistTable');
            const whitelistCount = document.getElementById('whitelistCount');
            
            whitelistCount.textContent = whitelist.length;
            whitelistTable.innerHTML = whitelist.map((user, index) => `
                <tr>
                    <td>${user.roomNumber}</td>
                    <td>${user.name}</td>
                    <td>${user.phone}</td>
                    <td>${usedRooms.includes(user.roomNumber) ? '<span style="color: red;">å·²æŠ½å¥–</span>' : '<span style="color: green;">æœªæŠ½å¥–</span>'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-edit" onclick="editUser(${index})">ç¼–è¾‘</button>
                        <button class="btn btn-reset" onclick="resetUserLottery('${user.roomNumber}')">é‡ç½®æŠ½å¥–</button>
                        <button class="btn btn-delete" onclick="deleteUser(${index})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        // é‡ç½®ç”¨æˆ·æŠ½å¥–çŠ¶æ€
        function resetUserLottery(roomNumber) {
            if (confirm(`ç¡®å®šè¦é‡ç½®æˆ¿å· ${roomNumber} çš„æŠ½å¥–çŠ¶æ€å—ï¼Ÿ`)) {
                // ä»å·²æŠ½å¥–åˆ—è¡¨ä¸­ç§»é™¤
                const index = usedRooms.indexOf(roomNumber);
                if (index > -1) {
                    usedRooms.splice(index, 1);
                }
                
                // ä¿å­˜æ•°æ®
                saveAllData();
                
                // æ›´æ–°æ˜¾ç¤º
                updateWhitelistDisplay();
                updateAdminStats();
                
                alert('é‡ç½®æˆåŠŸï¼è¯¥ç”¨æˆ·å¯ä»¥é‡æ–°æŠ½å¥–ã€‚');
            }
        }

        // æ›´æ–°å¥–å“æ˜¾ç¤º
        function updatePrizesDisplay() {
            const prizesTable = document.getElementById('prizesTable');
            const prizesCount = document.getElementById('prizesCount');
            
            prizesCount.textContent = prizes.length;
            prizesTable.innerHTML = prizes.map((prize, index) => `
                <tr>
                    <td>${prize.name}</td>
                    <td>${prize.quantity}</td>
                    <td>${prize.probability}%</td>
                    <td>${prize.won}</td>
                    <td class="action-buttons">
                        <button class="btn btn-edit" onclick="editPrize(${index})">ç¼–è¾‘</button>
                        <button class="btn btn-delete" onclick="deletePrize(${index})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        // æ˜¾ç¤ºæ–°å¢ç”¨æˆ·æ¨¡æ€æ¡†
        function showAddUserModal() {
            editingUserIndex = -1;
            document.getElementById('userModalTitle').textContent = 'æ–°å¢ç”¨æˆ·';
            document.getElementById('modalRoomNumber').value = '';
            document.getElementById('modalUserName').value = '';
            document.getElementById('modalUserPhone').value = '';
            document.getElementById('addUserModal').style.display = 'block';
        }

        // ç¼–è¾‘ç”¨æˆ·
        function editUser(index) {
            editingUserIndex = index;
            const user = whitelist[index];
            document.getElementById('userModalTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';
            document.getElementById('modalRoomNumber').value = user.roomNumber;
            document.getElementById('modalUserName').value = user.name;
            document.getElementById('modalUserPhone').value = user.phone;
            document.getElementById('addUserModal').style.display = 'block';
        }

        // ä¿å­˜ç”¨æˆ·
        function saveUser() {
            const roomNumber = document.getElementById('modalRoomNumber').value.trim();
            const name = document.getElementById('modalUserName').value.trim();
            const phone = document.getElementById('modalUserPhone').value.trim();
            
            if (!roomNumber || !name || !phone) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            if (editingUserIndex === -1) {
                // æ–°å¢ç”¨æˆ·
                whitelist.push({ roomNumber, name, phone });
            } else {
                // ç¼–è¾‘ç”¨æˆ·
                whitelist[editingUserIndex] = { roomNumber, name, phone };
            }
            
            saveAllData();
            updateWhitelistDisplay();
            closeModal('addUserModal');
        }

        // åˆ é™¤ç”¨æˆ·
        function deleteUser(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ')) {
                const user = whitelist[index];
                // åŒæ—¶ä»å·²æŠ½å¥–åˆ—è¡¨ä¸­ç§»é™¤
                const usedIndex = usedRooms.indexOf(user.roomNumber);
                if (usedIndex > -1) {
                    usedRooms.splice(usedIndex, 1);
                }
                
                whitelist.splice(index, 1);
                saveAllData();
                updateWhitelistDisplay();
            }
        }

        // æ˜¾ç¤ºæ–°å¢å¥–å“æ¨¡æ€æ¡†
        function showAddPrizeModal() {
            editingPrizeIndex = -1;
            document.getElementById('prizeModalTitle').textContent = 'æ–°å¢å¥–å“';
            document.getElementById('modalPrizeName').value = '';
            document.getElementById('modalPrizeQuantity').value = '';
            document.getElementById('modalPrizeProbability').value = '';
            document.getElementById('addPrizeModal').style.display = 'block';
        }

        // ç¼–è¾‘å¥–å“
        function editPrize(index) {
            editingPrizeIndex = index;
            const prize = prizes[index];
            document.getElementById('prizeModalTitle').textContent = 'ç¼–è¾‘å¥–å“';
            document.getElementById('modalPrizeName').value = prize.name;
            document.getElementById('modalPrizeQuantity').value = prize.quantity;
            document.getElementById('modalPrizeProbability').value = prize.probability;
            document.getElementById('addPrizeModal').style.display = 'block';
        }

        // ä¿å­˜å¥–å“
        function savePrize() {
            const name = document.getElementById('modalPrizeName').value.trim();
            const quantity = parseInt(document.getElementById('modalPrizeQuantity').value);
            const probability = parseFloat(document.getElementById('modalPrizeProbability').value);
            
            if (!name || !quantity || !probability) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            if (quantity < 1) {
                alert('å¥–å“æ•°é‡å¿…é¡»å¤§äº0');
                return;
            }
            
            if (probability < 0 || probability > 100) {
                alert('ä¸­å¥–æ¦‚ç‡å¿…é¡»åœ¨0-100ä¹‹é—´');
                return;
            }
            
            if (editingPrizeIndex === -1) {
                // æ–°å¢å¥–å“
                prizes.push({ name, quantity, probability, won: 0 });
            } else {
                // ç¼–è¾‘å¥–å“
                prizes[editingPrizeIndex] = { 
                    name, 
                    quantity, 
                    probability, 
                    won: prizes[editingPrizeIndex].won 
                };
            }
            
            // ç¡®ä¿å§‹ç»ˆåŒ…å«è°¢è°¢å‚ä¸
            ensureThankYouPrize();
            
            saveAllData();
            updatePrizesDisplay();
            closeModal('addPrizeModal');
            
            // é‡æ–°åˆå§‹åŒ–å››å®«æ ¼
            initLotteryGrid();
        }

        // åˆ é™¤å¥–å“ - é˜²æ­¢åˆ é™¤è°¢è°¢å‚ä¸
        function deletePrize(index) {
            if (prizes[index].name === 'è°¢è°¢å‚ä¸') {
                alert('è°¢è°¢å‚ä¸å¥–é¡¹ä¸èƒ½åˆ é™¤');
                return;
            }
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥–å“å—ï¼Ÿ')) {
                prizes.splice(index, 1);
                saveAllData();
                updatePrizesDisplay();
                initLotteryGrid();
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // å¤„ç†Excelæ–‡ä»¶å¯¼å…¥
        function handleFileImport(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    const validData = jsonData.filter(row => 
                        row.æˆ¿å· && row.å§“å && row.æ‰‹æœºå·
                    );
                    
                    if (validData.length === 0) {
                        alert('Excelæ–‡ä»¶ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç™½åå•æ•°æ®ï¼ˆéœ€è¦åŒ…å«æˆ¿å·ã€å§“åã€æ‰‹æœºå·åˆ—ï¼‰');
                        return;
                    }
                    
                    // è½¬æ¢æ•°æ®æ ¼å¼
                    const newWhitelist = validData.map(row => ({
                        roomNumber: row.æˆ¿å·.toString(),
                        name: row.å§“å.toString(),
                        phone: row.æ‰‹æœºå·.toString()
                    }));
                    
                    whitelist = newWhitelist;
                    saveAllData();
                    
                    updateWhitelistDisplay();
                    updateAdminStats();
                    
                    alert(`æˆåŠŸå¯¼å…¥ ${newWhitelist.length} æ¡ç™½åå•æ•°æ®`);
                    
                } catch (error) {
                    alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            adminPassword = newPassword;
            localStorage.setItem(STORAGE_KEYS.ADMIN_PASSWORD, adminPassword);
            alert('å¯†ç ä¿®æ”¹æˆåŠŸ');
            
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                lotteryRecords = [];
                usedRooms = [];
                saveAllData();
                alert('æ•°æ®å·²æ¸…ç©º');
                updateAdminStats();
                updateAllRecords();
            }
        }

        // å¯¼å‡ºæŠ½å¥–è®°å½•
        function exportRecords() {
            const worksheet = XLSX.utils.json_to_sheet(lotteryRecords.map(record => ({
                'æ—¶é—´': record.timestamp,
                'æˆ¿å·': record.roomNumber,
                'å§“å': record.name,
                'æ‰‹æœºå·': record.phone,
                'å¥–é¡¹': record.prize
            })));
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'æŠ½å¥–è®°å½•');
            XLSX.writeFile(workbook, `æŠ½å¥–è®°å½•_${new Date().toLocaleDateString()}.xlsx`);
        }

        // å¯¼å‡ºç™½åå•
        function exportWhitelist() {
            const worksheet = XLSX.utils.json_to_sheet(whitelist.map(user => ({
                'æˆ¿å·': user.roomNumber,
                'å§“å': user.name,
                'æ‰‹æœºå·': user.phone,
                'æŠ½å¥–çŠ¶æ€': usedRooms.includes(user.roomNumber) ? 'å·²æŠ½å¥–' : 'æœªæŠ½å¥–'
            })));
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ç™½åå•');
            XLSX.writeFile(workbook, `ç™½åå•_${new Date().toLocaleDateString()}.xlsx`);
        }

        // å¯¼å‡ºå®Œæ•´æ•°æ®
        function exportAllData() {
            const workbook = XLSX.utils.book_new();
            
            // ç™½åå•sheet
            const whitelistSheet = XLSX.utils.json_to_sheet(whitelist.map(user => ({
                'æˆ¿å·': user.roomNumber,
                'å§“å': user.name,
                'æ‰‹æœºå·': user.phone,
                'æŠ½å¥–çŠ¶æ€': usedRooms.includes(user.roomNumber) ? 'å·²æŠ½å¥–' : 'æœªæŠ½å¥–'
            })));
            XLSX.utils.book_append_sheet(workbook, whitelistSheet, 'ç™½åå•');
            
            // æŠ½å¥–è®°å½•sheet
            const recordsSheet = XLSX.utils.json_to_sheet(lotteryRecords.map(record => ({
                'æ—¶é—´': record.timestamp,
                'æˆ¿å·': record.roomNumber,
                'å§“å': record.name,
                'æ‰‹æœºå·': record.phone,
                'å¥–é¡¹': record.prize
            })));
            XLSX.utils.book_append_sheet(workbook, recordsSheet, 'æŠ½å¥–è®°å½•');
            
            // ç»Ÿè®¡æ•°æ®sheet
            const statsData = [
                { 'ç»Ÿè®¡é¡¹': 'æ€»ç”¨æˆ·æ•°', 'æ•°å€¼': whitelist.length },
                { 'ç»Ÿè®¡é¡¹': 'å·²å‚ä¸ç”¨æˆ·', 'æ•°å€¼': usedRooms.length },
                { 'ç»Ÿè®¡é¡¹': 'æ€»ä¸­å¥–æ•°', 'æ•°å€¼': lotteryRecords.filter(r => r.prize !== 'è°¢è°¢å‚ä¸').length },
                { 'ç»Ÿè®¡é¡¹': 'å‚ä¸ç‡', 'æ•°å€¼': whitelist.length > 0 ? Math.round((usedRooms.length / whitelist.length) * 100) + '%' : '0%' }
            ];
            const statsSheet = XLSX.utils.json_to_sheet(statsData);
            XLSX.utils.book_append_sheet(workbook, statsSheet, 'ç»Ÿè®¡æ•°æ®');

            // å¥–å“è®¾ç½®sheet
            const prizesSheet = XLSX.utils.json_to_sheet(prizes.map(prize => ({
                'å¥–å“åç§°': prize.name,
                'å¥–å“æ•°é‡': prize.quantity,
                'ä¸­å¥–æ¦‚ç‡': prize.probability + '%',
                'å·²ä¸­å¥–æ•°': prize.won
            })));
            XLSX.utils.book_append_sheet(workbook, prizesSheet, 'å¥–å“è®¾ç½®');
            
            XLSX.writeFile(workbook, `æŠ½å¥–ç³»ç»Ÿå®Œæ•´æ•°æ®_${new Date().toLocaleDateString()}.xlsx`);
        }

        // é€€å‡ºç™»å½• - ä¸æ¸…ç†è®°å½•
        function logout() {
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
            document.getElementById('adminSection').classList.remove('active');
            document.getElementById('loginSection').classList.add('active');
            
            // åªæ¸…ç©ºè¾“å…¥æ¡†ï¼Œä¸æ¸…ç†è®°å½•
            document.getElementById('roomNumber').value = '';
            document.getElementById('adminAccount').value = '';
            document.getElementById('adminPassword').value = '';
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ•°æ®
            initializeData();
            
            // ç¡®ä¿æ•°æ®å®Œæ•´æ€§
            ensureThankYouPrize();
            
            initLotteryGrid();
            
            // æ·»åŠ é¡µé¢åˆ·æ–°å‰çš„ä¿å­˜
            window.addEventListener('beforeunload', function() {
                saveAllData();
            });
        });
    </script>
</body>
</html>
